<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard — Cami</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/backend-ui.css">
    <script>
        (function(){try{var t=localStorage.getItem('cami-theme');if(t==='dark')document.documentElement.setAttribute('data-theme','dark');}catch(_){}})();
    </script>
</head>
<body class="backend-ui">
    <div class="backend-layout">
        <!-- Sidebar -->
        <aside class="backend-sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/" class="sidebar-logo">
                    <span class="sidebar-logo-text">Cami</span>
                    <span class="sidebar-logo-badge">Beta</span>
                </a>
            </div>
            
            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Overview</div>
                    <a href="/dashboard" class="sidebar-link active">
                        <svg class="sidebar-link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7" rx="1"/>
                            <rect x="14" y="3" width="7" height="7" rx="1"/>
                            <rect x="3" y="14" width="7" height="7" rx="1"/>
                            <rect x="14" y="14" width="7" height="7" rx="1"/>
                        </svg>
                        Dashboard
                    </a>
                    <a href="/app" class="sidebar-link">
                        <svg class="sidebar-link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        Chat with Cami
                    </a>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Services</div>
                    <a href="/app/law" class="sidebar-link" id="nav-law">
                        <svg class="sidebar-link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                        Law
                    </a>
                    <a href="/app/health" class="sidebar-link" id="nav-health">
                        <svg class="sidebar-link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                        Health
                    </a>
                    <a href="/customer-service/dashboard" class="sidebar-link" id="nav-cs">
                        <svg class="sidebar-link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 18.86h-5.69L8 22v-3.14H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10.86a2 2 0 0 1-2 2z"/>
                        </svg>
                        Customer Service
                    </a>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Platform</div>
                    <a href="/business" class="sidebar-link">
                        <svg class="sidebar-link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        Business
                    </a>
                    <a href="/platform" class="sidebar-link" id="nav-platform" style="display:none;">
                        <svg class="sidebar-link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                            <line x1="8" y1="21" x2="16" y2="21"/>
                            <line x1="12" y1="17" x2="12" y2="21"/>
                        </svg>
                        Control
                    </a>
                    <a href="/min" class="sidebar-link" id="nav-min" style="display:none;">
                        <svg class="sidebar-link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                        M.I.N.
                    </a>
                    <a href="/admin" class="sidebar-link" id="nav-admin" style="display:none;">
                        <svg class="sidebar-link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m7.08 7.08l4.24 4.24M1 12h6m6 0h6M4.22 19.78l4.24-4.24m7.08-7.08l4.24-4.24"/>
                        </svg>
                        Admin
                    </a>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div class="sidebar-user" id="sidebar-user" style="display:none;">
                    <div class="sidebar-user-avatar" id="user-avatar">U</div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="user-name">User</div>
                        <div class="sidebar-user-email" id="user-email">user@example.com</div>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main content -->
        <main class="backend-main">
            <header class="backend-header">
                <div class="header-left">
                    <button class="header-icon-btn" id="menu-toggle" style="display:none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"/>
                            <line x1="3" y1="6" x2="21" y2="6"/>
                            <line x1="3" y1="18" x2="21" y2="18"/>
                        </svg>
                    </button>
                    <div class="header-breadcrumb">
                        <span class="header-breadcrumb-item">Cami</span>
                        <span class="header-breadcrumb-sep">/</span>
                        <span class="header-breadcrumb-item current">Dashboard</span>
                    </div>
                </div>
                <div class="header-right">
                    <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
                        <svg class="icon-sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </svg>
                        <svg class="icon-moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </button>
                    <button class="btn btn-secondary btn-sm" id="btn-logout" style="display:none;">Sign out</button>
                </div>
            </header>
            
            <div class="backend-content">
                <!-- Loading state -->
                <div id="loading-state" class="empty-state">
                    <div class="spinner" style="margin: 0 auto var(--space-4);"></div>
                    <p class="text-muted">Loading your dashboard...</p>
                </div>
                
                <!-- Auth required state -->
                <div id="auth-state" style="display:none;">
                    <div class="card" style="max-width: 400px; margin: var(--space-16) auto;">
                        <div class="card-header" style="text-align: center;">
                            <h2 style="font-family: var(--font-serif); font-size: 1.5rem;">Welcome to Cami</h2>
                            <p class="card-subtitle">Sign in to access your dashboard</p>
                        </div>
                        <div class="card-body">
                            <div id="auth-error" class="alert alert-danger mb-4" style="display:none;"></div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="auth-email" placeholder="you@example.com" autocomplete="email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" id="auth-password" placeholder="••••••••" autocomplete="current-password">
                            </div>
                            <div class="flex gap-3">
                                <button class="btn btn-primary" id="btn-signin" style="flex:1;">Sign in</button>
                                <button class="btn btn-secondary" id="btn-signup" style="flex:1;">Sign up</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dashboard content -->
                <div id="dashboard-content" style="display:none;">
                    <!-- Success banner -->
                    <div id="success-banner" class="alert alert-success mb-6" style="display:none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        <span id="success-banner-text"></span>
                    </div>
                    
                    <!-- Welcome section -->
                    <div class="mb-6">
                        <h1 style="font-size: 1.5rem; margin-bottom: var(--space-2);">
                            Good <span id="greeting-time">day</span>, <span id="greeting-name">there</span>
                        </h1>
                        <p class="text-muted">Here's what's happening with your Cami account.</p>
                    </div>
                    
                    <!-- Plan badge -->
                    <div class="flex items-center gap-3 mb-6">
                        <span id="plan-badge" class="badge badge-primary">Free</span>
                        <span class="text-sm text-muted" id="plan-description">Upgrade to access all features</span>
                    </div>
                    
                    <!-- Quick stats -->
                    <div class="grid grid-cols-4 mb-6" id="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-icon accent">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                </svg>
                            </div>
                            <div class="stat-card-label">Conversations</div>
                            <div class="stat-card-value" id="stat-conversations">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon info">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                </svg>
                            </div>
                            <div class="stat-card-label">API Calls</div>
                            <div class="stat-card-value" id="stat-usage">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon warning">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                </svg>
                            </div>
                            <div class="stat-card-label">API Keys</div>
                            <div class="stat-card-value" id="stat-keys">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                </svg>
                            </div>
                            <div class="stat-card-label">Services</div>
                            <div class="stat-card-value" id="stat-services">0</div>
                        </div>
                    </div>
                    
                    <!-- Two column layout -->
                    <div class="grid" style="grid-template-columns: 1fr 380px; gap: var(--space-6);">
                        <!-- Left column -->
                        <div class="flex flex-col gap-6">
                            <!-- Your Services -->
                            <div class="card" id="services-card">
                                <div class="card-header">
                                    <div>
                                        <h3 class="card-title">Your Services</h3>
                                        <p class="card-subtitle">Quick access to your subscribed Cami services</p>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="services-list" class="grid gap-3">
                                        <!-- Services will be rendered here -->
                                    </div>
                                    <div id="services-empty" class="empty-state" style="padding: var(--space-8);">
                                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                        </svg>
                                        <h4 class="empty-state-title">No active services</h4>
                                        <p class="empty-state-description">Subscribe to Cami Law, Health, or Customer Service to get started.</p>
                                        <a href="#billing-section" class="btn btn-primary">View Plans</a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- API Keys -->
                            <div class="card" id="keys-card" style="display:none;">
                                <div class="card-header">
                                    <div>
                                        <h3 class="card-title">API Keys</h3>
                                        <p class="card-subtitle">Manage your API keys for programmatic access</p>
                                    </div>
                                    <button class="btn btn-secondary btn-sm" id="btn-create-key">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"/>
                                            <line x1="5" y1="12" x2="19" y2="12"/>
                                        </svg>
                                        Create Key
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="keys-list"></div>
                                    <div id="new-key-display" class="alert alert-success mt-4" style="display:none;">
                                        <div style="flex:1;">
                                            <p class="font-semibold mb-2">Your new API key (copy it now — it won't be shown again):</p>
                                            <code id="new-key-value" class="font-mono" style="word-break: break-all;"></code>
                                        </div>
                                        <button class="btn btn-sm btn-secondary" id="btn-copy-key">Copy</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right column -->
                        <div class="flex flex-col gap-6">
                            <!-- Subscription -->
                            <div class="card" id="billing-section">
                                <div class="card-header">
                                    <div>
                                        <h3 class="card-title">Subscription</h3>
                                        <p class="card-subtitle" id="billing-status">Manage your plan and billing</p>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Active subscriptions -->
                                    <div id="active-subs" style="display:none;" class="mb-4">
                                        <div class="section-title mb-3">Active Subscriptions</div>
                                        <div id="active-subs-list" class="flex flex-col gap-2"></div>
                                    </div>
                                    
                                    <!-- Pricing options -->
                                    <div id="pricing-options" class="flex flex-col gap-3">
                                        <div class="flex items-center justify-between p-4" style="background: var(--surface-secondary); border-radius: var(--radius-md); border: 1px solid var(--border-default);">
                                            <div>
                                                <div class="font-semibold">Cami Law</div>
                                                <div class="text-sm text-muted">Legal research & drafting</div>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <span class="font-semibold">$29/mo</span>
                                                <button class="btn btn-primary btn-sm checkout-btn" data-plan="law">Subscribe</button>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between p-4" style="background: var(--surface-secondary); border-radius: var(--radius-md); border: 1px solid var(--border-default);">
                                            <div>
                                                <div class="font-semibold">Cami Health</div>
                                                <div class="text-sm text-muted">Clinical decision support</div>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <span class="font-semibold">$29/mo</span>
                                                <button class="btn btn-primary btn-sm checkout-btn" data-plan="health">Subscribe</button>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between p-4" style="background: var(--accent-subtle); border-radius: var(--radius-md); border: 1px solid var(--accent);">
                                            <div>
                                                <div class="font-semibold" style="color: var(--accent);">Cami Pro <span class="badge badge-primary" style="margin-left: var(--space-2);">Best Value</span></div>
                                                <div class="text-sm text-muted">Law + Health + Priority</div>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <span class="font-semibold">$49/mo</span>
                                                <button class="btn btn-primary btn-sm checkout-btn" data-plan="pro">Subscribe</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="divider"></div>
                                    
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-muted">Need B2B or Enterprise?</span>
                                        <a href="/business" class="text-sm">Business Dashboard →</a>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <button class="btn btn-secondary" id="btn-portal">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                            <line x1="1" y1="10" x2="23" y2="10"/>
                                        </svg>
                                        Manage Billing
                                    </button>
                                    <span id="portal-error" class="text-sm" style="color: var(--danger); margin-left: var(--space-3); display:none;"></span>
                                </div>
                            </div>
                            
                            <!-- Usage -->
                            <div class="card" id="usage-card">
                                <div class="card-header">
                                    <div>
                                        <h3 class="card-title">Usage This Month</h3>
                                        <p class="card-subtitle" id="usage-period">Current billing period</p>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="usage-breakdown" class="flex flex-col gap-3"></div>
                                    <div class="divider"></div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-muted">Total API calls</span>
                                        <span class="font-semibold" id="usage-total">0</span>
                                    </div>
                                    <div id="usage-limit-bar" class="mt-3" style="display:none;">
                                        <div class="progress">
                                            <div class="progress-bar" id="usage-progress" style="width: 0%;"></div>
                                        </div>
                                        <div class="flex justify-between mt-2 text-xs text-muted">
                                            <span id="usage-current">0</span>
                                            <span id="usage-limit">0 limit</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Admin section -->
                    <div class="card mt-6" id="admin-section" style="display:none;">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Admin Overview</h3>
                                <p class="card-subtitle">Platform-wide metrics and management</p>
                            </div>
                            <a href="/admin" class="btn btn-secondary btn-sm">Full Admin Panel →</a>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-4 gap-4" id="admin-metrics"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Scripts -->
    <script src="/static/js/supabase.min.js"></script>
    <script>
    if (typeof window.supabase === 'undefined') {
        var s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        s.crossOrigin = 'anonymous';
        s.onerror = function() {
            var t = document.createElement('script');
            t.src = 'https://unpkg.com/@supabase/supabase-js@2';
            t.crossOrigin = 'anonymous';
            document.head.appendChild(t);
        };
        document.head.appendChild(s);
    }
    </script>
    <script>
(function() {
    let supabase = null;
    let token = null;
    let config = {};
    let userPlan = 'free';
    let userData = {};

    // ─── Theme Toggle ─────────────────────────────────────────────────────────
    document.getElementById('theme-toggle').addEventListener('click', function() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? '' : 'dark');
        localStorage.setItem('cami-theme', isDark ? '' : 'dark');
    });

    // ─── Helpers ──────────────────────────────────────────────────────────────
    function waitSupabase(cb, tries) {
        tries = tries || 0;
        if (typeof window.supabase !== 'undefined') { cb(); return; }
        if (tries > 50) { cb(); return; }
        setTimeout(function() { waitSupabase(cb, tries + 1); }, 100);
    }

    async function getConfig() {
        try {
            const r = await fetch('/api/config');
            return await r.json();
        } catch (e) {
            console.warn('Dashboard: could not load /api/config', e);
            return { supabase_url: '', supabase_anon_key: '' };
        }
    }

    function apiHeaders() {
        const h = { 'Content-Type': 'application/json' };
        if (token) h['Authorization'] = 'Bearer ' + token;
        return h;
    }

    function escHtml(t) { return (t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    function getGreeting() {
        const hour = new Date().getHours();
        if (hour < 12) return 'morning';
        if (hour < 18) return 'afternoon';
        return 'evening';
    }

    // ─── Service Definitions ──────────────────────────────────────────────────
    const SERVICE_INFO = {
        cami: { url: '/app', name: 'Cami', desc: 'Conversational AI', icon: 'chat' },
        customer_service: { url: '/customer-service/dashboard', name: 'Customer Service', desc: 'Support automation', icon: 'cs' },
        health: { url: '/app/health', name: 'Health', desc: 'Clinical decision support', icon: 'health' },
        legal_intelligence: { url: '/app/law', name: 'Law', desc: 'Legal research & drafting', icon: 'law' },
        research: { url: '/app?mode=research', name: 'Research', desc: 'Multi-round synthesis', icon: 'research' },
        tutor: { url: '/app?mode=tutor', name: 'Tutor', desc: 'Learning assistant', icon: 'tutor' },
        cami_money: { url: '/app?mode=cami_money', name: 'Money', desc: 'Financial AI', icon: 'money' }
    };

    function getServiceIcon(key) {
        const icons = {
            chat: '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>',
            cs: '<path d="M18 18.86h-5.69L8 22v-3.14H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10.86a2 2 0 0 1-2 2z"/>',
            health: '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>',
            law: '<path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>',
            research: '<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>',
            tutor: '<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>',
            money: '<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>'
        };
        const info = SERVICE_INFO[key] || {};
        return icons[info.icon] || icons.chat;
    }

    // ─── UI Updates ───────────────────────────────────────────────────────────
    function showLoading() {
        document.getElementById('loading-state').style.display = '';
        document.getElementById('auth-state').style.display = 'none';
        document.getElementById('dashboard-content').style.display = 'none';
    }

    function showAuth() {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('auth-state').style.display = '';
        document.getElementById('dashboard-content').style.display = 'none';
    }

    function showDashboard() {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('auth-state').style.display = 'none';
        document.getElementById('dashboard-content').style.display = '';
        document.getElementById('btn-logout').style.display = '';
        document.getElementById('sidebar-user').style.display = '';
        document.getElementById('greeting-time').textContent = getGreeting();
    }

    function updateUserInfo(me) {
        userData = me;
        const email = me.email || 'User';
        const name = email.split('@')[0];
        document.getElementById('greeting-name').textContent = name;
        document.getElementById('user-name').textContent = name;
        document.getElementById('user-email').textContent = email;
        document.getElementById('user-avatar').textContent = name.charAt(0).toUpperCase();
    }

    function updatePlan(me) {
        userPlan = (me.plan || 'free').toLowerCase();
        const subscriptions = me.subscriptions || [];
        const activeSubs = subscriptions.filter(s => s.status === 'active');
        const activeServices = activeSubs.map(s => s.service);
        // Admin detection: API flag or plan only (server-side controlled)
        const isAdmin = me.is_admin === true || userPlan === 'admin';

        // Plan badge
        let displayName = 'Free';
        let badgeClass = 'badge-default';
        if (isAdmin) { displayName = 'Admin'; badgeClass = 'badge-primary'; }
        else if (activeServices.includes('pro')) { displayName = 'Pro'; badgeClass = 'badge-primary'; }
        else if (activeSubs.length > 0) {
            const names = { law: 'Law', health: 'Health', pro: 'Pro' };
            displayName = activeSubs.map(s => names[s.service] || s.service).join(' + ');
            badgeClass = 'badge-primary';
        }

        const badge = document.getElementById('plan-badge');
        badge.textContent = displayName;
        badge.className = 'badge ' + badgeClass;

        const desc = document.getElementById('plan-description');
        if (isAdmin) desc.textContent = 'Full platform access';
        else if (activeSubs.length > 0) desc.textContent = 'Active subscription';
        else desc.textContent = 'Upgrade to access all features';

        // Active subscriptions list
        const subsEl = document.getElementById('active-subs');
        const subsList = document.getElementById('active-subs-list');
        if (isAdmin) {
            // Admin gets full access display - subscribed to everything
            subsEl.style.display = '';
            subsList.innerHTML = `
                <div class="flex items-center gap-2"><span class="status-dot online"></span><span class="font-medium">Full Platform Access</span><span class="badge badge-primary">Admin</span></div>
                <div class="flex items-center gap-2"><span class="status-dot online"></span><span class="font-medium">Cami Pro</span><span class="badge badge-success">Active</span></div>
                <div class="flex items-center gap-2"><span class="status-dot online"></span><span class="font-medium">Cami Law</span><span class="badge badge-success">Active</span></div>
                <div class="flex items-center gap-2"><span class="status-dot online"></span><span class="font-medium">Cami Health</span><span class="badge badge-success">Active</span></div>
                <div class="flex items-center gap-2"><span class="status-dot online"></span><span class="font-medium">Customer Service</span><span class="badge badge-success">Active</span></div>
                <div class="flex items-center gap-2"><span class="status-dot online"></span><span class="font-medium">Human+ API</span><span class="badge badge-success">Active</span></div>
                <div class="flex items-center gap-2"><span class="status-dot online"></span><span class="font-medium">Research</span><span class="badge badge-success">Active</span></div>
                <div class="flex items-center gap-2"><span class="status-dot online"></span><span class="font-medium">Tutor</span><span class="badge badge-success">Active</span></div>
                <div class="flex items-center gap-2"><span class="status-dot online"></span><span class="font-medium">Cami Money</span><span class="badge badge-success">Active</span></div>
            `;
        } else if (activeSubs.length > 0) {
            subsEl.style.display = '';
            const names = { law: 'Cami Law', health: 'Cami Health', pro: 'Cami Pro' };
            subsList.innerHTML = activeSubs.map(s => 
                '<div class="flex items-center gap-2"><span class="status-dot online"></span><span class="font-medium">' + 
                (names[s.service] || s.service) + '</span><span class="badge badge-success">Active</span></div>'
            ).join('');
        } else {
            subsEl.style.display = 'none';
        }

        // Hide pricing for subscribed services
        const pricingEl = document.getElementById('pricing-options');
        if (activeServices.includes('pro') || isAdmin) {
            pricingEl.style.display = 'none';
        } else {
            pricingEl.querySelectorAll('.checkout-btn').forEach(btn => {
                const plan = btn.dataset.plan;
                if (activeServices.includes(plan)) {
                    btn.textContent = 'Active';
                    btn.disabled = true;
                    btn.className = 'btn btn-secondary btn-sm';
                }
            });
        }

        // Show admin nav items
        if (isAdmin) {
            ['nav-platform', 'nav-min', 'nav-admin'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = '';
            });
        }

        // Show/hide keys section (admins always can)
        const canCreateKeys = me.can_create_api_keys || isAdmin;
        document.getElementById('keys-card').style.display = canCreateKeys ? '' : 'none';
    }

    function renderServices(entitlements) {
        const list = document.getElementById('services-list');
        const empty = document.getElementById('services-empty');
        
        if (!entitlements || entitlements.length === 0) {
            list.style.display = 'none';
            empty.style.display = '';
            return;
        }

        list.style.display = '';
        empty.style.display = 'none';
        
        list.innerHTML = entitlements.map(slug => {
            const info = SERVICE_INFO[slug] || { url: '/app', name: slug, desc: '' };
            return `
                <a href="${info.url}" class="flex items-center gap-4 p-4 card-hover" style="background: var(--surface-secondary); border-radius: var(--radius-md); border: 1px solid var(--border-default); text-decoration: none; color: inherit;">
                    <div style="width: 40px; height: 40px; border-radius: var(--radius-md); background: var(--accent-subtle); display: flex; align-items: center; justify-content: center; color: var(--accent);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${getServiceIcon(slug)}</svg>
                    </div>
                    <div style="flex:1;">
                        <div class="font-semibold">${escHtml(info.name)}</div>
                        <div class="text-sm text-muted">${escHtml(info.desc)}</div>
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--text-muted);">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </a>
            `;
        }).join('');

        // Update stats
        document.getElementById('stat-services').textContent = entitlements.length;
    }

    function renderKeys(keys) {
        const list = document.getElementById('keys-list');
        if (!keys || keys.length === 0) {
            list.innerHTML = '<p class="text-muted text-sm">No API keys yet. Create one to get started.</p>';
            document.getElementById('stat-keys').textContent = '0';
            return;
        }

        document.getElementById('stat-keys').textContent = keys.length;
        list.innerHTML = keys.map(k => `
            <div class="flex items-center justify-between p-3" style="background: var(--surface-secondary); border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                <div class="flex items-center gap-3">
                    <code class="text-sm font-mono">${escHtml(k.key_prefix || '')}...</code>
                    <span class="text-sm text-muted">${escHtml(k.name || 'Default')}</span>
                </div>
                <span class="badge badge-success">Active</span>
            </div>
        `).join('');
    }

    function renderUsage(data, isAdmin) {
        const breakdown = document.getElementById('usage-breakdown');
        const byKey = data.by_key || [];
        
        if (byKey.length === 0) {
            breakdown.innerHTML = '<p class="text-muted text-sm">No usage data yet.</p>';
        } else {
            breakdown.innerHTML = byKey.map(u => `
                <div class="flex items-center justify-between">
                    <span class="text-sm">${escHtml(u.name || u.key_prefix)}</span>
                    <span class="font-medium">${u.count || 0} calls</span>
                </div>
            `).join('');
        }

        const total = data.total || 0;
        const limit = data.plan_limit;
        
        document.getElementById('stat-usage').textContent = total.toLocaleString();
        document.getElementById('usage-total').textContent = total.toLocaleString();
        document.getElementById('usage-period').textContent = 'Period: ' + (data.period || 'Current month');

        if (isAdmin) {
            // Admin has unlimited
            document.getElementById('usage-limit-bar').style.display = '';
            document.getElementById('usage-progress').style.width = '0%';
            document.getElementById('usage-current').textContent = total.toLocaleString() + ' used';
            document.getElementById('usage-limit').textContent = 'Unlimited';
        } else if (typeof limit === 'number' && limit > 0) {
            const pct = Math.min(100, (total / limit) * 100);
            document.getElementById('usage-limit-bar').style.display = '';
            document.getElementById('usage-progress').style.width = pct + '%';
            document.getElementById('usage-current').textContent = total.toLocaleString() + ' used';
            document.getElementById('usage-limit').textContent = limit.toLocaleString() + ' limit';
        }
    }

    async function loadAdminMetrics() {
        try {
            const r = await fetch('/api/admin/metrics', { headers: apiHeaders() });
            if (!r.ok) return;
            const m = await r.json();
            
            document.getElementById('admin-section').style.display = '';
            const grid = document.getElementById('admin-metrics');
            grid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-card-label">Total Users</div>
                    <div class="stat-card-value">${(m.total_profiles || 0).toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">API Keys</div>
                    <div class="stat-card-value">${(m.total_api_keys || 0).toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Usage (Month)</div>
                    <div class="stat-card-value">${(m.usage_this_month || 0).toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Period</div>
                    <div class="stat-card-value text-sm">${m.period || '—'}</div>
                </div>
            `;
        } catch (e) {
            console.warn('Admin metrics error', e);
        }
    }

    // ─── Data Loading ─────────────────────────────────────────────────────────
    async function loadDashboardData() {
        try {
            const [meRes, keysRes, usageRes] = await Promise.all([
                fetch('/api/me', { headers: apiHeaders() }),
                fetch('/api/keys', { headers: apiHeaders() }),
                fetch('/api/usage', { headers: apiHeaders() })
            ]);

            let isAdmin = false;
            
            if (meRes.ok) {
                const me = await meRes.json();
                updateUserInfo(me);
                updatePlan(me);
                
                // Admin gets all services (server-side controlled)
                isAdmin = me.is_admin === true || (me.plan || '').toLowerCase() === 'admin';
                if (isAdmin) {
                    renderServices(['cami', 'legal_intelligence', 'health', 'customer_service', 'research', 'tutor']);
                } else {
                    renderServices(me.service_entitlements || []);
                }
                
                // Update conversation stat
                document.getElementById('stat-conversations').textContent = (me.conversation_count || 0).toLocaleString();
                
                if (isAdmin) {
                    loadAdminMetrics();
                }
            }

            if (keysRes.ok) {
                const data = await keysRes.json();
                renderKeys(data.keys || []);
            }

            if (usageRes.ok) {
                const data = await usageRes.json();
                renderUsage(data, isAdmin);
            }

            // Check for checkout success in URL
            const params = new URLSearchParams(location.search);
            if (params.get('checkout') === 'success') {
                const plan = params.get('plan') || 'subscription';
                document.getElementById('success-banner').style.display = '';
                document.getElementById('success-banner-text').textContent = 
                    'Welcome! Your ' + plan.replace(/_/g, ' ') + ' subscription is now active.';
                history.replaceState({}, '', location.pathname);
            }
        } catch (e) {
            console.error('Dashboard data error', e);
        }
    }

    // ─── Auth ─────────────────────────────────────────────────────────────────
    async function signIn() {
        const email = document.getElementById('auth-email').value.trim();
        const password = document.getElementById('auth-password').value;
        const errEl = document.getElementById('auth-error');
        errEl.style.display = 'none';

        if (!email || !password) {
            errEl.textContent = 'Email and password required';
            errEl.style.display = '';
            return;
        }

        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
            errEl.textContent = error.message;
            errEl.style.display = '';
            return;
        }

        token = data.session.access_token;
        showDashboard();
        loadDashboardData();
    }

    async function signUp() {
        const email = document.getElementById('auth-email').value.trim();
        const password = document.getElementById('auth-password').value;
        const errEl = document.getElementById('auth-error');
        errEl.style.display = 'none';

        if (!email || !password) {
            errEl.textContent = 'Email and password required';
            errEl.style.display = '';
            return;
        }

        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) {
            errEl.textContent = error.message;
            errEl.style.display = '';
            return;
        }

        if (data.session) {
            token = data.session.access_token;
            showDashboard();
            loadDashboardData();
        } else {
            errEl.textContent = 'Check your email to confirm sign up.';
            errEl.style.display = '';
        }
    }

    async function logout() {
        await supabase.auth.signOut();
        token = null;
        location.reload();
    }

    // ─── API Key Creation ─────────────────────────────────────────────────────
    async function createApiKey() {
        const name = prompt('Enter a name for this API key:', 'Default');
        if (!name) return;

        try {
            const res = await fetch('/api/keys', {
                method: 'POST',
                headers: apiHeaders(),
                body: JSON.stringify({ name: name.trim() })
            });

            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                alert(data.detail || 'Could not create API key');
                return;
            }

            const data = await res.json();
            if (data.key) {
                document.getElementById('new-key-value').textContent = data.key;
                document.getElementById('new-key-display').style.display = '';
                loadDashboardData();
            }
        } catch (e) {
            alert('Network error');
        }
    }

    // ─── Checkout ─────────────────────────────────────────────────────────────
    async function startCheckout(plan) {
        try {
            const res = await fetch('/api/billing/checkout', {
                method: 'POST',
                headers: apiHeaders(),
                body: JSON.stringify({ plan: plan })
            });

            const data = await res.json().catch(() => ({}));
            if (res.ok && data.url) {
                window.location.href = data.url;
            } else {
                alert(data.error || 'Could not start checkout');
            }
        } catch (e) {
            alert('Network error');
        }
    }

    async function openBillingPortal() {
        const errEl = document.getElementById('portal-error');
        errEl.style.display = 'none';

        try {
            const res = await fetch('/api/billing/portal', { headers: apiHeaders() });
            const data = await res.json().catch(() => ({}));
            if (res.ok && data.url) {
                window.location.href = data.url;
            } else {
                errEl.textContent = data.error || 'Could not open billing portal';
                errEl.style.display = '';
            }
        } catch (e) {
            errEl.textContent = 'Network error';
            errEl.style.display = '';
        }
    }

    // ─── Init ─────────────────────────────────────────────────────────────────
    async function init() {
        showLoading();

        await new Promise(resolve => waitSupabase(resolve));
        if (typeof window.supabase === 'undefined') {
            showAuth();
            return;
        }

        config = await getConfig();
        if (!config.supabase_url || !config.supabase_anon_key) {
            showAuth();
            return;
        }

        supabase = window.supabase.createClient(config.supabase_url, config.supabase_anon_key);
        const { data: { session } } = await supabase.auth.getSession();

        if (session) {
            token = session.access_token;
            showDashboard();
            loadDashboardData();
        } else {
            showAuth();
        }

        // Event listeners
        document.getElementById('btn-signin').addEventListener('click', signIn);
        document.getElementById('btn-signup').addEventListener('click', signUp);
        document.getElementById('btn-logout').addEventListener('click', logout);
        document.getElementById('btn-create-key').addEventListener('click', createApiKey);
        document.getElementById('btn-portal').addEventListener('click', openBillingPortal);
        document.getElementById('btn-copy-key').addEventListener('click', function() {
            const key = document.getElementById('new-key-value').textContent;
            navigator.clipboard.writeText(key).then(() => alert('Copied to clipboard'));
        });

        // Checkout buttons
        document.querySelectorAll('.checkout-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!this.disabled) startCheckout(this.dataset.plan);
            });
        });

        // Enter key on password field
        document.getElementById('auth-password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') signIn();
        });
    }

    init();
})();
    </script>
</body>
</html>
